name: PR Validation

on:
  pull_request:
    branches: [main]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in diff
        run: |
          echo "Checking for potential secrets in changed files..."

          # Files that should never be committed
          FORBIDDEN_FILES=(
            ".env"
            "credentials.json"
            ".env.local"
            ".env.production"
            "*.pem"
            "*.key"
          )

          for pattern in "${FORBIDDEN_FILES[@]}"; do
            if git diff --name-only origin/main...HEAD | grep -E "$pattern"; then
              echo "Error: Forbidden file detected: $pattern"
              exit 1
            fi
          done

          # Check for common secret patterns in diff (exclude variable assignments like "passwordError")
          # Only match actual secret values (long strings starting with common prefixes)
          if git diff origin/main...HEAD | grep -E "(api_key|secret|token).*=.*['\"][a-zA-Z0-9_-]{32,}['\"]"; then
            echo "Warning: Potential secret detected in diff"
            echo "Please review your changes carefully"
            exit 1
          fi

          echo "No secrets detected"

      - name: Validate commit messages
        run: |
          echo "Validating commit messages..."

          # Get commits between base and head
          COMMITS=$(git log --format=%s origin/main..HEAD)

          if [ -z "$COMMITS" ]; then
            echo "No commits found"
            exit 0
          fi

          echo "$COMMITS" | while read -r msg; do
            # Ensure commit messages are descriptive (>10 chars)
            if [ ${#msg} -lt 10 ]; then
              echo "Error: Commit message too short: $msg"
              exit 1
            fi
          done

          echo "Commit messages validated"

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/main...HEAD | wc -l)
          LINES_CHANGED=$(git diff --shortstat origin/main...HEAD | awk '{print $4+$6}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          # Warn on large PRs (>20 files or >1000 lines)
          if [ "$FILES_CHANGED" -gt 20 ] || [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "Warning: Large PR detected"
            echo "Consider breaking this into smaller, focused PRs"
          fi

      - name: Verify architecture compliance
        run: |
          echo "Checking architecture compliance..."

          # Ensure no CRUD endpoints in FastAPI
          if git diff origin/main...HEAD -- apps/backend/api/main.py | grep -iE "(create|read|update|delete).*endpoint"; then
            echo "Warning: Potential CRUD endpoint detected in FastAPI"
            echo "Remember: All CRUD should go through Supabase directly"
          fi

          # Check that trash/ directory is used for deletions
          DELETED_FILES=$(git diff --name-only --diff-filter=D origin/main...HEAD)
          if [ -n "$DELETED_FILES" ]; then
            echo "Files deleted in this PR:"
            echo "$DELETED_FILES"
            echo ""
            echo "Reminder: Archive deleted code in trash/ directory with timestamp"
          fi

          echo "Architecture compliance check complete"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan for Python
        if: contains(github.event.pull_request.changed_files, 'apps/backend')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install and run safety
        if: contains(github.event.pull_request.changed_files, 'apps/backend')
        run: |
          pip install safety
          cd apps/backend/api
          safety check --json || echo "Security vulnerabilities found - please review"

  all-checks-complete:
    name: All Checks Complete
    runs-on: ubuntu-latest
    needs: [validate-pr, security-scan]

    steps:
      - name: Summary
        run: |
          echo "All PR validation checks completed successfully"
          echo "Ready for review"
